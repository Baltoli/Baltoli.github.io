<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Programming - TESLA Documentation</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">TESLA Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">Home</a>
                    </li>
                    <li >
                        <a href="../installation/">Installation</a>
                    </li>
                    <li class="active">
                        <a href="./">Programming</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../installation/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li class="disabled">
                        <a rel="prev" >
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="http://github.com/cadets/tesla-static-analysis">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#programming-with-tesla">Programming with TESLA</a></li>
            <li><a href="#tesla-basics">TESLA Basics</a></li>
            <li><a href="#example">Example</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="programming-with-tesla">Programming with TESLA</h1>
<p>This page walks you through how to use TESLA. It explains how TESLA is
implemented (and some associated terminology), how to use the toolchain, then
how to start writing useful assertions about your programs.</p>
<h2 id="tesla-basics">TESLA Basics</h2>
<p>TESLA is implemented as a set of tools that extend the traditional C compilation
process. To write TESLA assertions, you need to add these tools to your
build system and generate the TESLA intermediate products.</p>
<h3 id="intermediate-products">Intermediate Products</h3>
<p>To use TESLA, you need to generate some extra intermediate products during your
build process. These products are:</p>
<ul>
<li><strong>Assertions</strong>: the assertions you write about a program are parsed out and
  written to external files in a structured format.</li>
<li><strong>Manifest</strong>: assertions in one file can reference those written in other
  files, so they need to be merged into one manifest file.</li>
<li><strong>LLVM IR</strong>: your code needs to be compiled to LLVM IR so that the TESLA tools
  can analyse and modify it.</li>
<li><strong>Instrumented IR</strong>: the assertion manifest is used to add TESLA
  instrumentation code to the compiled LLVM IR.</li>
</ul>
<p>A dependency graph between these products is shown in the graph below.</p>
<p><img alt="" src="../process.dot.svg" /></p>
<h3 id="toolchain">Toolchain</h3>
<p>To generate TESLA intermediate products, you use the TESLA command-line tools.
These are:</p>
<ul>
<li><code>tesla analyse</code> generates an assertion file (<code>.tesla</code>) from a C source file.</li>
<li><code>tesla cat</code> combines assertion files together into a manifest.</li>
<li><code>tesla instrument</code> uses a manifest to add instrumentation code to IR.</li>
</ul>
<p>Your C programs need to be compiled using <code>clang</code> 4.0. To generate LLVM IR from
a C source, use the flags <code>-c -emit-llvm</code>.</p>
<h2 id="example">Example</h2>
<p>It&rsquo;s useful to work through a simple example to get a feel for the TESLA
toolchain and assertion language. The scenario we&rsquo;ll consider here is a <a href="https://en.wikipedia.org/wiki/Mutual_exclusion">mutual
exclusion lock</a>, with the aim of preventing deadlock.</p>
<p>The example code in this guide can be found <a href="https://github.com/Baltoli/tesla-examples/blob/master/site/locks.c">here</a>.</p>
<h3 id="setup">Setup</h3>
<p>The first step is to establish the data structures and operations we&rsquo;ll be
working with. At its simplest, a mutual exclusion lock can be modelled by a
structure with a single boolean field:</p>
<pre><code class="c">#include &lt;stdatomic.h&gt;
#include &lt;stdbool.h&gt;

struct lock {
  _Atomic(bool) held;
};
</code></pre>

<p>If we have a lock, the only things we can do are to <em>acquire</em> or <em>release</em> it:</p>
<pre><code class="c">bool lock_acquire(struct lock *l) {
  bool f = false;
  return atomic_compare_exchange_strong(&amp;(lock-&gt;held), &amp;f, true);
}

void lock_release(struct lock *l) {
  l-&gt;held = false;
}
</code></pre>

<p>These operations are thread safe (because they&rsquo;re written using the C11 atomics
library). If <code>lock_acquire</code> is called on a lock that&rsquo;s already held, it returns
<code>false</code>. If we acquired the lock successfully, then it returns <code>true</code>.</p>
<p>The simplest possible program that uses the lock is:</p>
<pre><code class="c">int main(void) {
  struct lock *l = malloc(sizeof(*lock));

  lock_acquire(l);
  lock_release(l);

  free(lock);
  return 0;
}
</code></pre>

<p>Because of limitations in the TESLA assertion parser, it can&rsquo;t currently work
with stack-allocated structures. Memory has to be dynamically allocated instead.</p>
<h3 id="a-first-assertion">A First Assertion</h3>
<p>To prevent deadlock in code that uses these locks, the property we&rsquo;d like to
assert is that a lock must eventually be released after it is acquired. The
TESLA expression of this property is:</p>
<pre><code class="c">#include &lt;tesla-macros.h&gt;

bool lock_acquire(struct lock *l) {
  TESLA_WITHIN(main, eventually(
    call(lock_release(l))
  ));

  bool f = false;
  return atomic_compare_exchange_strong(&amp;(lock-&gt;held), &amp;f, true);
}
</code></pre>

<p>There&rsquo;s quite a few things going on here. <code>TESLA_WITHIN</code> is the primary starting
point for TESLA assertions. Its first argument should be a function that acts as
a &ldquo;bounding context&rdquo;, and the second argument is a TESLA assertion.</p>
<p>A bounding context limits the scope of an assertion. When the context function
is called, TESLA performs internal initialisation (and cleanup when it returns).
In this example, the bounding context is <code>main</code>. For small programs this is OK,
but for larger programs it can lead to performance issues. Generally speaking,
it&rsquo;s best to use the narrowest bound possible for your assertions.</p>
<p>The assertion itself uses the <code>eventually</code> macro, which states that the body of
the macro (<code>call(lock_release(l))</code>) happens at some point <em>after</em> the assertion
site (i.e. the location of <code>TESLA_WITHIN(...)</code>).</p>
<p>Altogether, the assertion states that &ldquo;during each execution of <code>main</code>, if the
assertion site is reached, <code>lock_release</code> is eventually called with <code>l</code> as its
argument&rdquo;. Note that if the assertion site is not reached, then the assertion
does not fail.</p>
<p>We can compile this first example using:</p>
<pre><code class="shell">clang -O0 -c -emit-llvm locks.c -o locks.bc
tesla analyse locks.c -o locks.tesla --
tesla instrument -tesla-manifest locks.tesla locks.bc -o locks.instr.bc
clang locks.instr.bc -o locks
</code></pre>

<p>Running <code>./locks</code> will produce no output, as expected&mdash;the usage of the lock is
correct. If you modify the body of <code>main</code> to acquire but not release <code>l</code>, then
running the compiled executable will produce a TESLA crash:</p>
<pre><code>TESLA failure:
In automaton 'locks.c:21#0':
TESLA_WITHIN(main, eventually(
    call(lock_release(l))
  ));
Instance 1 is in state 2
but received event '--(main() == X (Callee) &lt;&lt;cleanup&gt;&gt;)--&gt;('NFA:5')'
(causes transition in: [ (1:0x0 -&gt; 3:0x0 &lt;clean&gt;) (4:0x1 -&gt; 3:0x0 &lt;clean&gt;) ])

locks: TESLA: failure in 'locks.c:21#0' --(main() == X (Callee) &lt;&lt;cleanup&gt;&gt;)--&gt;('NFA:5'): bad transition
</code></pre>

<h3 id="debugging">Debugging</h3>
<p>The TESLA crash in the previous section is rather difficult to understand. We
can get a better picture of it by using <code>tesla print</code> to print out a DOT
formatted version of the TESLA internal automaton:</p>
<pre><code class="shell">tesla print -d -format=dot locks.tesla
</code></pre>

<p>This produces output that looks like this:</p>
<p><img alt="" src="../auto.dot.svg" /></p>
<p>It&rsquo;s still not the easiest to understand, but we can get a better idea of why
the assertion failed&mdash;the automaton was in state 2, but received the <code>main() cleanup</code> event. From state 2, we can see that (as expected), instead of reaching
the end of <code>main</code>, we should have called <code>lock_release</code>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
